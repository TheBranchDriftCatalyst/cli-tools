version: 3

vars:
  LOCAL_BIN:
    sh: realpath ./bin

tasks:
  build:
    desc: Build Go CLI commands
    silent: false
    sources:
      - "./cmd/**/main.go"
      - "./cmd/**/go.mod"
      - "./cmd/**/go.sum"
      - "./go.mod"
      - "./go.sum"
    generates:
      - "{{ .LOCAL_BIN }}/*"
    cmds:
      - for: { var: CLI_DIRS, split: "\n" }
        cmd: |
          PROJECT_NAME=$(basename {{ .ITEM }})
          if [ -f "{{ .ITEM }}/go.mod" ]; then
            echo "Building $PROJECT_NAME (separate module)"
            go build -C {{ .ITEM }} -o {{ .LOCAL_BIN }}/$PROJECT_NAME .
          else
            echo "Building $PROJECT_NAME"
            go build -o {{ .LOCAL_BIN }}/$PROJECT_NAME ./{{ .ITEM }}/main.go
          fi
    vars:
      CLI_DIRS:
        sh: ls -d cmd/*/

  fmt:
    desc: Format Go code
    cmds:
      - go fmt ./cmd/...

  vet:
    desc: Run go vet on Go code
    cmds:
      - go vet ./cmd/...

  lint:
    desc: Lint Go code
    cmds:
      - |
        if command -v golangci-lint >/dev/null 2>&1; then
          golangci-lint run ./cmd/...
        else
          echo "golangci-lint not installed. Install with: brew install golangci-lint"
          go vet ./cmd/...
        fi
