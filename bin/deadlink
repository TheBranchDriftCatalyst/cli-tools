#!/bin/bash
#
# @(#) deadlink v0.2.0
#
# usage:
#   deadlink [options] [dir(s)]
#
# description:
#   Remove the broken symlinks
#
######################################################################

DRY_RUN=false
INTERACTIVE=true

# Parse options
while [[ $# -gt 0 ]]; do
    case $1 in
        -n|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -y|--yes)
            INTERACTIVE=false
            shift
            ;;
        -h|--help)
            echo "usage: deadlink [options] [dir(s)]" 1>&2
            echo "  Remove broken symlinks within the given directories" 1>&2
            echo "  If no directory is specified, defaults to \$HOME" 1>&2
            echo "" 1>&2
            echo "options:" 1>&2
            echo "  -n, --dry-run    Show what would be removed without actually removing" 1>&2
            echo "  -y, --yes        Skip interactive confirmation" 1>&2
            echo "  -h, --help       Show this help message" 1>&2
            exit 0
            ;;
        -*)
            echo "Error: Unknown option $1" 1>&2
            echo "Use --help for usage information" 1>&2
            exit 1
            ;;
        *)
            # This is a directory argument, stop parsing options
            break
            ;;
    esac
done

# Set default directory if none provided
DIRS=("${@:-$HOME}")

# Count broken symlinks first
broken_count=0
for arg in "${DIRS[@]}"; do
    for f in "$arg"/.??* "$arg"/*; do
        [ -L "$f" ] && ! [ -e "$f" ] && ((broken_count++))
    done
done

if [ $broken_count -eq 0 ]; then
    echo "‚úÖ No broken symlinks found in the specified directories."
    exit 0
fi

echo "üîç Found $broken_count broken symlink(s)"

if [ "$DRY_RUN" = true ]; then
    echo "üß™ DRY RUN MODE - No files will be deleted"
fi

# Process directories
for arg in "${DIRS[@]}"; do
    echo "üìÅ Checking directory: $arg"

    for f in "$arg"/.??* "$arg"/*; do
        # -L: check for a symlink; -e: check for validation of symlink
        if [ -L "$f" ] && ! [ -e "$f" ]; then
            if [ "$DRY_RUN" = true ]; then
                echo "  üóëÔ∏è  Would remove: $f"
            else
                if [ "$INTERACTIVE" = true ]; then
                    echo "  üóëÔ∏è  Remove broken symlink: $f"
                    read -p "     Delete? [y/N] " -n 1 -r
                    echo
                    if [[ $REPLY =~ ^[Yy]$ ]]; then
                        rm "$f" && echo "     ‚úÖ Removed"
                    else
                        echo "     ‚è≠Ô∏è  Skipped"
                    fi
                else
                    rm "$f" && echo "  ‚úÖ Removed: $f"
                fi
            fi
        fi
    done
done

if [ "$DRY_RUN" = true ]; then
    echo "üß™ DRY RUN complete. Use without --dry-run to actually remove files."
fi
